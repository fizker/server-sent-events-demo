<!doctype html>

<style>
	th {
		text-align: right;
	}
	.buttons {
		text-align: right;
	}

	#incoming {
		margin-left: 10px;
	}

	#messages th {
		text-align: left;
	}

	body {
		display: flex;
	}

	body > * {
		flex-grow: 1;
	}
</style>

<section>
	<h1>Send message</h1>

<form method="post" action="/messages" onsubmit="onSubmit(event).catch(console.error)">
	<table>
		<tr>
			<th><label for="event-type">Event type:</label></th>
			<td><input id="event-type" name="type" value="message"></td>
		</tr>
		<tr>
			<th><label for="event-id">Event id:</label></th>
			<td><input id="event-id" name="id"></td>
		</tr>
		<tr>
			<th><label for="event-data">Data:</label></th>
			<td><textarea id="event-data" name="data"></textarea></td>
		</tr>
		<tr>
			<td colspan="2" class="buttons">
				<button>Send event</button>
			</td>
		</tr>
	</table>
</form>

	<div id="send-status">
	</div>
</section>

<section id="incoming">
	<h1>Client</h1>
	<label>
		Status:
		<span id="status">Connectingâ€¦</span>
	</label>
	<h2>Messages</h2>
	<table>
		<thead>
			<tr>
				<th>Type</th>
				<th>ID</th>
				<th>Data</th>
			</tr>
		</thead>
		<tbody id="messages">
		</tbody>
	</table>
</section>

<script>
	const sendStatusLabel = document.querySelector("#send-status")
	const statusLabel = document.querySelector("#status")
	const messageContainer = document.querySelector("#messages")

	const eventSource = new EventSource("/messages")
	eventSource.addEventListener("test", (event) => {
		console.log({ type: "test", event })
	}, false)
	eventSource.onopen = () => {
		console.log("Event source is open")
		statusLabel.innerHTML = "Open"
	}
	eventSource.onmessage = (message) => {
		console.log({ message })
		const row = messageContainer.insertRow(0)
		row.insertCell().innerHTML = new Date().toJSON()
		row.insertCell().innerHTML = message.type
		row.insertCell().innerHTML = message.lastEventId
		row.insertCell().innerHTML = message.data
	}

	async function onSubmit(event) {
		event.preventDefault()

		const form = event.currentTarget
		const data = new FormData(form)
		const body = new URLSearchParams(data)
		const res = await fetch(form.action, {
			method: form.method,
			body,
		})
		const message = await res.text()
		sendStatusLabel.innerHTML = message
	}
</script>
